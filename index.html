<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4CAF50">
    <title>Marketing Prospect App</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1hcmtldGluZyBQcm9zcGVjdCBBcHAiLAogICJzaG9ydF9uYW1lIjogIlByb3NwZWN0IiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJ0aGVtZV9jb2xvciI6ICIjNENBRjUwIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTWpRaUlHaGxhV2RvZEQwaU1qUWlJSFpwWlhkQ2IzZzlJakFnTUNBeU5DQXlOQ0lnZG1WeWMybHZiajBpTVM0eElpQjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaVBnbzhjR0YwYUNCbWFXeHNQU0lqTkVOQlJqVXdJaUJrUFNKTk1USXVNalF0TVRNZ01USXVNalF0TVRNZ09TNHpOaUF6TGpZMExUSXVNalF0TVRNZ05TNHlORzh0TURVZ01UUXVNVFJ5TXk0Mk5DMHlMakkyT1RNZ05DNHdPQzAwTGpZek9UTXRNUzR6Tm5wdE5TNDBNaTB5TGpZNE9USXhMamhwTFRJdU5qa3pPUzB4TGprMU5qSXVOek13TFRVdU1qTXhNaTQzTkRJdE5TNHlNekV6TGpVME9TMHdMakEwTWpZdE5pNHdOQ0l2UGdvOEwzTjJaejQ9IiwKICAgICAgInNpemVzIjogIjI0eDI0IiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        .mobile-container {
            max-width: 100%;
            margin: 0;
            background: white;
            min-height: 100vh;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 12px 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: none;
            font-size: 11px;
            color: #666;
        }

        .nav-item.active {
            color: #4CAF50;
            background: #f0f8f0;
        }

        .nav-item .icon {
            font-size: 20px;
            display: block;
            margin-bottom: 4px;
        }

        .content {
            padding: 15px;
            padding-bottom: 80px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stats-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stats-card.primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .stats-card.warning {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }

        .stats-card.info {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
        }

        .stats-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stats-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .progress-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
        }

        .progress-percentage {
            font-size: 1.5em;
            font-weight: bold;
            color: #4CAF50;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .progress-text {
            font-size: 0.9em;
            color: #666;
            text-align: center;
        }

        /* Form Styles */
        .form-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            -webkit-appearance: none;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
            width: 100%;
            font-weight: 600;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        .btn-whatsapp {
            background: linear-gradient(135deg, #25D366, #128C7E);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .gps-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 12px;
            margin-top: 10px;
            font-size: 14px;
            color: #2e7d32;
        }

        /* Prospect Card Styles */
        .prospect-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .prospect-card:active {
            transform: scale(0.98);
        }

        .prospect-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .prospect-date {
            font-weight: bold;
            color: #4CAF50;
            font-size: 1.1em;
        }

        .prospect-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-penawaran { background: #e3f2fd; color: #1976d2; }
        .status-on-progress { background: #fff3e0; color: #f57c00; }
        .status-negosiasi { background: #fce4ec; color: #c2185b; }
        .status-acc { background: #e8f5e8; color: #2e7d32; }
        .status-prospek { background: #f3e5f5; color: #7b1fa2; }

        .prospect-details {
            display: grid;
            gap: 12px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            flex-shrink: 0;
            margin-right: 10px;
        }

        .detail-value {
            font-weight: 600;
            color: #333;
            text-align: right;
            flex-grow: 1;
        }

        .prospect-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .prospect-actions .btn {
            flex: 1;
            padding: 12px;
            font-size: 14px;
            margin: 0;
        }

        /* Filter Styles */
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-style: italic;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #dc3545;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .header {
                padding: 15px 10px;
            }
            
            .content {
                padding: 10px;
            }
            
            .form-card,
            .stats-card,
            .progress-card,
            .prospect-card {
                padding: 15px;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
            }
        }

        /* PWA Install Button */
        .install-prompt {
            position: fixed;
            bottom: 80px;
            left: 15px;
            right: 15px;
            background: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 12px;
            display: none;
            z-index: 99;
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <div class="header">
            <h1>üéØ Marketing Prospect</h1>
            <p>Kelola prospek dengan mudah</p>
        </div>

        <div class="content">
            <div id="message-container"></div>

            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <div class="dashboard-grid">
                    <div class="stats-card primary">
                        <div class="stats-number" id="total-prospects">0</div>
                        <div class="stats-label">Total Prospek Bulan Ini</div>
                    </div>
                    
                    <div class="stats-card warning">
                        <div class="stats-number" id="pending-prospects">0</div>
                        <div class="stats-label">Pending Follow-up</div>
                    </div>
                    
                    <div class="stats-card info">
                        <div class="stats-number" id="acc-prospects">0</div>
                        <div class="stats-label">ACC Bulan Ini</div>
                    </div>
                </div>

                <div class="progress-card">
                    <div class="progress-header">
                        <div class="progress-title">Target Bulanan (Paket 10)</div>
                        <div class="progress-percentage" id="progress-percentage">0%</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progress-text">0 dari 10 target tercapai</div>
                </div>

                <div class="form-card">
                    <h3 style="margin-bottom: 15px; color: #333;">üìä Ringkasan Status</h3>
                    <div id="status-summary"></div>
                </div>
            </div>

            <!-- Add Prospect Page -->
            <div id="add-prospect" class="page">
                <div class="form-card">
                    <h3 style="margin-bottom: 20px; color: #333;">‚ûï Tambah Prospek Baru</h3>
                    
                    <form id="prospect-form">
                        <div class="form-group">
                            <label for="tanggal-prospek">üìÖ Tanggal Prospek</label>
                            <input type="date" id="tanggal-prospek" required>
                        </div>

                        <div class="form-group">
                            <label for="segmentasi">üè¢ Segmentasi</label>
                            <select id="segmentasi" required>
                                <option value="">Pilih Segmentasi</option>
                                <option value="Rumah">üè† Rumah</option>
                                <option value="Kost">üè† Kost</option>
                                <option value="Kantor">üè¢ Kantor</option>
                                <option value="Hotel">üè® Hotel</option>
                                <option value="Bank">üè¶ Bank</option>
                                <option value="Swasta">üè≠ Swasta</option>
                                <option value="FNB">üçΩÔ∏è FNB</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="jenis-prospek">üîß Jenis Prospek</label>
                            <select id="jenis-prospek" required>
                                <option value="">Pilih Jenis Prospek</option>
                                <option value="Maintenance">üîß Maintenance</option>
                                <option value="Instalasi">‚öôÔ∏è Instalasi</option>
                                <option value="Pengadaan AC">‚ùÑÔ∏è Pengadaan AC</option>
                                <option value="Project Lengkap">üèóÔ∏è Project Lengkap</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="tindak-lanjut">üìã Status Tindak Lanjut</label>
                            <select id="tindak-lanjut" required>
                                <option value="">Pilih Status</option>
                                <option value="Prospek">üîç Prospek</option>
                                <option value="Penawaran">üìÑ Penawaran</option>
                                <option value="On Progress">‚è≥ On Progress</option>
                                <option value="Negosiasi">üí¨ Negosiasi</option>
                                <option value="ACC">‚úÖ ACC</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="lokasi-prospek">üìç Lokasi Prospek</label>
                            <input type="text" id="lokasi-prospek" placeholder="Masukkan alamat lengkap" required>
                        </div>

                        <div class="form-group">
                            <label>üó∫Ô∏è Titik Lokasi GPS</label>
                            <button type="button" class="btn btn-secondary" onclick="getCurrentLocation()">
                                üìç Ambil Lokasi GPS
                            </button>
                            <div id="gps-info" class="gps-info" style="display: none;"></div>
                            <input type="hidden" id="latitude">
                            <input type="hidden" id="longitude">
                        </div>

                        <div class="form-group">
                            <label for="permintaan-owner">üí≠ Permintaan Owner (Max 500 karakter)</label>
                            <textarea id="permintaan-owner" maxlength="500" placeholder="Deskripsikan permintaan khusus dari owner"></textarea>
                            <small id="char-count" style="color: #666; font-size: 12px;">0/500 karakter</small>
                        </div>

                        <div class="form-group">
                            <label>üì∏ Kirim Foto via WhatsApp</label>
                            <button type="button" class="btn btn-whatsapp" onclick="sendPhotoWA()">
                                <span style="font-size: 20px;">üì±</span>
                                Kirim Foto via WhatsApp
                            </button>
                            <small style="display: block; margin-top: 8px; color: #666; font-size: 12px;">
                                Foto akan dikirim ke admin via WhatsApp
                            </small>
                        </div>

                        <button type="submit" class="btn">
                            üíæ Simpan Prospek
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            üîÑ Reset Form
                        </button>
                    </form>
                </div>
            </div>

            <!-- View Prospects Page -->
            <div id="view-prospects" class="page">
                <div class="filter-section">
                    <h3 style="margin-bottom: 15px; color: #333;">üîç Filter Prospek</h3>
                    <div class="filter-grid">
                        <div class="form-group">
                            <label for="filter-segmentasi">Segmentasi</label>
                            <select id="filter-segmentasi" onchange="applyFilters()">
                                <option value="">Semua</option>
                                <option value="Rumah">Rumah</option>
                                <option value="Kost">Kost</option>
                                <option value="Kantor">Kantor</option>
                                <option value="Hotel">Hotel</option>
                                <option value="Bank">Bank</option>
                                <option value="Swasta">Swasta</option>
                                <option value="FNB">FNB</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filter-status">Status</label>
                            <select id="filter-status" onchange="applyFilters()">
                                <option value="">Semua</option>
                                <option value="Prospek">Prospek</option>
                                <option value="Penawaran">Penawaran</option>
                                <option value="On Progress">On Progress</option>
                                <option value="Negosiasi">Negosiasi</option>
                                <option value="ACC">ACC</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="clearFilters()" style="flex: 1;">üóëÔ∏è Clear</button>
                        <button class="btn btn-warning" onclick="exportData()" style="flex: 1;">üìä Export</button>
                    </div>
                </div>

                <div id="prospects-container">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="showPage('dashboard')">
                <span class="icon">üìä</span>
                <span>Dashboard</span>
            </button>
            <button class="nav-item" onclick="showPage('add-prospect')">
                <span class="icon">‚ûï</span>
                <span>Tambah</span>
            </button>
            <button class="nav-item" onclick="showPage('view-prospects')">
                <span class="icon">üìã</span>
                <span>Lihat</span>
            </button>
        </div>

        <!-- PWA Install Prompt -->
        <div id="install-prompt" class="install-prompt">
            <strong>üì± Install Aplikasi</strong><br>
            Tambahkan ke home screen untuk akses cepat!
            <button onclick="installPWA()" style="float: right; background: none; border: none; color: white; font-size: 18px;">‚úñÔ∏è</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc,
            query,
            orderBy,
            onSnapshot,
            where
        } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyApnkc7A462AqSG0_mbMGM4SvCjuFwqsF0",
            authDomain: "businessnala-f9440.firebaseapp.com",
            projectId: "businessnala-f9440",
            storageBucket: "businessnala-f9440.firebasestorage.app",
            messagingSenderId: "461868188651",
            appId: "1:461868188651:web:b0267defcbfa35f99bcfae",
            measurementId: "G-W3D639SCR7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.firebaseModules = {
            collection, addDoc, getDocs, doc, updateDoc, deleteDoc,
            query, orderBy, onSnapshot, where
        };

        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            setupRealTimeListener();
        });
    </script>

    <script>
        let allProspects = [];
        let filteredProspects = [];
        let deferredPrompt;

        // PWA Installation
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-prompt').style.display = 'block';
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    deferredPrompt = null;
                });
            }
            document.getElementById('install-prompt').style.display = 'none';
        }

        // Page Navigation
        function showPage(pageId) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            
            event.target.closest('.nav-item').classList.add('active');
            document.getElementById(pageId).classList.add('active');

            if (pageId === 'dashboard') {
                loadDashboardData();
            } else if (pageId === 'view-prospects') {
                loadProspects();
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggal-prospek').value = today;

            // Character counter
            const textarea = document.getElementById('permintaan-owner');
            const charCount = document.getElementById('char-count');
            
            textarea.addEventListener('input', function() {
                const remaining = this.value.length;
                charCount.textContent = `${remaining}/500 karakter`;
                
                if (remaining > 450) {
                    charCount.style.color = '#f44336';
                } else if (remaining > 400) {
                    charCount.style.color = '#ff9800';
                } else {
                    charCount.style.color = '#666';
                }
            });
        });

        // GPS functionality
        function getCurrentLocation() {
            if (navigator.geolocation) {
                const button = event.target;
                button.innerHTML = '‚è≥ Mengambil Lokasi...';
                button.disabled = true;

                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        document.getElementById('latitude').value = lat;
                        document.getElementById('longitude').value = lng;
                        
                        const gpsInfo = document.getElementById('gps-info');
                        gpsInfo.innerHTML = `
                            <strong>üìç Lokasi GPS berhasil diambil!</strong><br>
                            Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}<br>
                            <a href="https://maps.google.com/?q=${lat},${lng}" target="_blank" style="color: #4CAF50;">Lihat di Google Maps</a>
                        `;
                        gpsInfo.style.display = 'block';
                        
                        button.innerHTML = '‚úÖ GPS Tersimpan';
                        button.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                        button.disabled = false;

                        showMessage('üìç Lokasi GPS berhasil diambil!', 'success');
                    },
                    function(error) {
                        showMessage('‚ùå Gagal mengambil lokasi GPS: ' + error.message, 'error');
                        button.innerHTML = 'üìç Ambil Lokasi GPS';
                        button.disabled = false;
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                );
            } else {
                showMessage('‚ùå GPS tidak didukung oleh browser ini', 'error');
            }
        }

        // WhatsApp photo function
        function sendPhotoWA() {
            const lokasi = document.getElementById('lokasi-prospek').value;
            const segmentasi = document.getElementById('segmentasi').value;
            const jenisProspek = document.getElementById('jenis-prospek').value;
            
            let message = `üì∏ *FOTO PROSPEK MARKETING*\n\n`;
            
            if (lokasi) message += `üìç Lokasi: ${lokasi}\n`;
            if (segmentasi) message += `üè¢ Segmentasi: ${segmentasi}\n`;
            if (jenisProspek) message += `üîß Jenis: ${jenisProspek}\n`;
            
            message += `\nüì∑ Mohon kirim foto prospek untuk lokasi di atas.`;
            
            const phoneNumber = '6287846919314';
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
            showMessage('üì± WhatsApp terbuka. Kirim foto prospek ke admin!', 'success');
        }

        // Form submission
        document.getElementById('prospect-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ Menyimpan...';
            submitBtn.disabled = true;
            
            const formData = {
                tanggalProspek: document.getElementById('tanggal-prospek').value,
                segmentasi: document.getElementById('segmentasi').value,
                jenisProspek: document.getElementById('jenis-prospek').value,
                lokasiProspek: document.getElementById('lokasi-prospek').value,
                tindakLanjut: document.getElementById('tindak-lanjut').value,
                permintaanOwner: document.getElementById('permintaan-owner').value,
                latitude: document.getElementById('latitude').value,
                longitude: document.getElementById('longitude').value,
                createdAt: new Date(),
                updatedAt: new Date()
            };

            try {
                const { collection, addDoc } = window.firebaseModules;
                await addDoc(collection(window.db, 'prospects'), formData);
                
                showMessage('‚úÖ Prospek berhasil disimpan!', 'success');
                resetForm();
                loadDashboardData();
                
            } catch (error) {
                console.error('Error adding document: ', error);
                showMessage('‚ùå Gagal menyimpan prospek: ' + error.message, 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Reset form
        function resetForm() {
            document.getElementById('prospect-form').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggal-prospek').value = today;
            
            document.getElementById('gps-info').style.display = 'none';
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            document.getElementById('char-count').textContent = '0/500 karakter';
            document.getElementById('char-count').style.color = '#666';
            
            const gpsButton = document.querySelector('[onclick="getCurrentLocation()"]');
            gpsButton.innerHTML = 'üìç Ambil Lokasi GPS';
            gpsButton.style.background = '';
            gpsButton.disabled = false;
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const { collection, getDocs, query, where } = window.firebaseModules;
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const startOfMonthStr = startOfMonth.toISOString().split('T')[0];

                // Get all prospects for this month
                const q = query(
                    collection(window.db, 'prospects'),
                    where('tanggalProspek', '>=', startOfMonthStr)
                );
                const querySnapshot = await getDocs(q);
                
                const monthlyProspects = [];
                querySnapshot.forEach((doc) => {
                    monthlyProspects.push({ id: doc.id, ...doc.data() });
                });

                // Calculate statistics
                const totalProspects = monthlyProspects.length;
                const pendingProspects = monthlyProspects.filter(p => 
                    ['Prospek', 'Penawaran', 'On Progress', 'Negosiasi'].includes(p.tindakLanjut)
                ).length;
                const accProspects = monthlyProspects.filter(p => p.tindakLanjut === 'ACC').length;

                // Update dashboard
                document.getElementById('total-prospects').textContent = totalProspects;
                document.getElementById('pending-prospects').textContent = pendingProspects;
                document.getElementById('acc-prospects').textContent = accProspects;

                // Update progress (target 10 per month)
                const target = 10;
                const percentage = Math.min((totalProspects / target) * 100, 100);
                
                document.getElementById('progress-percentage').textContent = `${Math.round(percentage)}%`;
                document.getElementById('progress-fill').style.width = `${percentage}%`;
                document.getElementById('progress-text').textContent = `${totalProspects} dari ${target} target tercapai`;

                // Status summary
                const statusCounts = {};
                monthlyProspects.forEach(p => {
                    statusCounts[p.tindakLanjut] = (statusCounts[p.tindakLanjut] || 0) + 1;
                });

                const statusSummary = document.getElementById('status-summary');
                statusSummary.innerHTML = Object.entries(statusCounts)
                    .map(([status, count]) => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                            <span>${getStatusIcon(status)} ${status}</span>
                            <strong>${count}</strong>
                        </div>
                    `).join('');

                allProspects = monthlyProspects;

            } catch (error) {
                console.error('Error loading dashboard: ', error);
                showMessage('‚ùå Gagal memuat data dashboard', 'error');
            }
        }

        function getStatusIcon(status) {
            const icons = {
                'Prospek': 'üîç',
                'Penawaran': 'üìÑ', 
                'On Progress': '‚è≥',
                'Negosiasi': 'üí¨',
                'ACC': '‚úÖ'
            };
            return icons[status] || 'üìã';
        }

        // Load prospects
        async function loadProspects() {
            const container = document.getElementById('prospects-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const { collection, getDocs, query, orderBy } = window.firebaseModules;
                const q = query(collection(window.db, 'prospects'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                
                allProspects = [];
                querySnapshot.forEach((doc) => {
                    allProspects.push({ id: doc.id, ...doc.data() });
                });
                
                filteredProspects = [...allProspects];
                displayProspects();
                
            } catch (error) {
                console.error('Error loading prospects: ', error);
                container.innerHTML = '<div class="no-data">‚ùå Gagal memuat data prospek</div>';
            }
        }

        // Setup real-time listener
        function setupRealTimeListener() {
            try {
                const { collection, query, orderBy, onSnapshot } = window.firebaseModules;
                const q = query(collection(window.db, 'prospects'), orderBy('createdAt', 'desc'));
                
                onSnapshot(q, (querySnapshot) => {
                    allProspects = [];
                    querySnapshot.forEach((doc) => {
                        allProspects.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Update dashboard if on dashboard page
                    if (document.getElementById('dashboard').classList.contains('active')) {
                        loadDashboardData();
                    }
                    
                    // Update prospects list if on view page
                    if (document.getElementById('view-prospects').classList.contains('active')) {
                        applyFilters();
                    }
                });
                
            } catch (error) {
                console.error('Error setting up real-time listener: ', error);
            }
        }

        // Display prospects
        function displayProspects() {
            const container = document.getElementById('prospects-container');
            
            if (filteredProspects.length === 0) {
                container.innerHTML = '<div class="no-data">üîç Tidak ada prospek yang ditemukan</div>';
                return;
            }

            container.innerHTML = filteredProspects.map(prospect => {
                const date = new Date(prospect.tanggalProspek).toLocaleDateString('id-ID');
                const statusClass = `status-${prospect.tindakLanjut.toLowerCase().replace(' ', '-')}`;
                
                return `
                    <div class="prospect-card">
                        <div class="prospect-header">
                            <div class="prospect-date">${date}</div>
                            <div class="prospect-status ${statusClass}">${prospect.tindakLanjut}</div>
                        </div>
                        
                        <div class="prospect-details">
                            <div class="detail-item">
                                <span class="detail-label">Segmentasi</span>
                                <span class="detail-value">${prospect.segmentasi}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Jenis</span>
                                <span class="detail-value">${prospect.jenisProspek}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Lokasi</span>
                                <span class="detail-value">${prospect.lokasiProspek}</span>
                            </div>
                            ${prospect.latitude && prospect.longitude ? `
                            <div class="detail-item">
                                <span class="detail-label">GPS</span>
                                <span class="detail-value">
                                    <a href="https://maps.google.com/?q=${prospect.latitude},${prospect.longitude}" target="_blank" style="color: #4CAF50;">
                                        üìç Maps
                                    </a>
                                </span>
                            </div>
                            ` : ''}
                        </div>
                        
                        ${prospect.permintaanOwner ? `
                        <div style="margin-top: 15px; background: #f8f9fa; padding: 12px; border-radius: 8px;">
                            <div class="detail-label" style="margin-bottom: 5px;">Permintaan Owner</div>
                            <div style="font-size: 14px; color: #333;">${prospect.permintaanOwner}</div>
                        </div>
                        ` : ''}
                        
                        <div class="prospect-actions">
                            <button class="btn btn-secondary" onclick="editProspect('${prospect.id}')">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="btn btn-danger" onclick="deleteProspect('${prospect.id}')">
                                üóëÔ∏è Hapus
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Edit prospect
        async function editProspect(id) {
            const prospect = allProspects.find(p => p.id === id);
            if (!prospect) return;

            const statuses = ['Prospek', 'Penawaran', 'On Progress', 'Negosiasi', 'ACC'];
            let statusOptions = statuses.map(status => 
                status === prospect.tindakLanjut ? `${status} ‚Üê (Current)` : status
            ).join('\n');

            const newStatus = prompt(
                `Edit Status Tindak Lanjut:\n\n${statusOptions}\n\nMasukkan status baru:`,
                prospect.tindakLanjut
            );

            if (newStatus && statuses.includes(newStatus)) {
                try {
                    const { doc, updateDoc } = window.firebaseModules;
                    await updateDoc(doc(window.db, 'prospects', id), {
                        tindakLanjut: newStatus,
                        updatedAt: new Date()
                    });
                    
                    showMessage('‚úÖ Status berhasil diperbarui!', 'success');
                    
                } catch (error) {
                    console.error('Error updating prospect: ', error);
                    showMessage('‚ùå Gagal memperbarui status', 'error');
                }
            } else if (newStatus !== null) {
                showMessage('‚ùå Status tidak valid', 'error');
            }
        }

        // Delete prospect
        async function deleteProspect(id) {
            if (confirm('‚ùå Apakah Anda yakin ingin menghapus prospek ini?')) {
                try {
                    const { doc, deleteDoc } = window.firebaseModules;
                    await deleteDoc(doc(window.db, 'prospects', id));
                    
                    showMessage('‚úÖ Prospek berhasil dihapus!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting prospect: ', error);
                    showMessage('‚ùå Gagal menghapus prospek', 'error');
                }
            }
        }

        // Apply filters
        function applyFilters() {
            const segmentasi = document.getElementById('filter-segmentasi').value;
            const status = document.getElementById('filter-status').value;

            filteredProspects = allProspects.filter(prospect => {
                return (!segmentasi || prospect.segmentasi === segmentasi) &&
                       (!status || prospect.tindakLanjut === status);
            });

            displayProspects();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('filter-segmentasi').value = '';
            document.getElementById('filter-status').value = '';
            
            filteredProspects = [...allProspects];
            displayProspects();
        }

        // Export data
        function exportData() {
            if (filteredProspects.length === 0) {
                showMessage('‚ùå Tidak ada data untuk diekspor', 'error');
                return;
            }

            const csvData = [
                ['Tanggal', 'Segmentasi', 'Jenis Prospek', 'Lokasi', 'Status', 'Permintaan Owner', 'GPS Latitude', 'GPS Longitude']
            ];

            filteredProspects.forEach(prospect => {
                csvData.push([
                    prospect.tanggalProspek,
                    prospect.segmentasi,
                    prospect.jenisProspek,
                    prospect.lokasiProspek,
                    prospect.tindakLanjut,
                    prospect.permintaanOwner || '',
                    prospect.latitude || '',
                    prospect.longitude || ''
                ]);
            });

            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `prospek-marketing-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            window.URL.revokeObjectURL(url);
            showMessage('‚úÖ Data berhasil diekspor!', 'success');
        }

        // Show message
        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            const messageClass = type === 'success' ? 'success-message' : 'error-message';
            
            container.innerHTML = `<div class="${messageClass}">${message}</div>`;
            container.scrollIntoView({ behavior: 'smooth' });
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
